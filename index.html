<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SGC MPSBBB – Agro Map (com Toolbar otimizada)</title>

  <!-- Leaflet & plugins (com defer) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
  <script defer src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script defer src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

  <script defer src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.js"></script>
  <script defer src="https://unpkg.com/togeojson@0.16.0"></script>
  <script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.7.570/pdf.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- Suporte a KMZ -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    :root{
      --brand-blue:#2563eb; --brand-blue-dark:#1d4ed8; --bg:#f4f7fb; --ink:#0f172a; --muted:#6b7280;
      --panel-grad:linear-gradient(180deg,#fff 0%,#fbfdff 100%); --card-border:#e8eef7; --ctrl-border:#e5e7eb;
      --hud-bg: rgba(10,18,33,.78); --hud-fg:#e5e7eb; --hud-border: rgba(255,255,255,.12);
      --hud-shadow1:0 10px 24px rgba(0,0,0,.18); --hud-shadow2:0 2px 6px rgba(0,0,0,.08);
      --hud-chip-bg:rgba(255,255,255,.06); --hud-chip-bd:rgba(255,255,255,.14);
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    #map{
      position:absolute;
      inset:0;
      top:0; right:0; bottom:0; left:0;
    }
    .hidden{display:none!important}

    #controls{
      position:absolute;top:10px;left:10px;z-index:920;
      width:250px; min-width:260px; max-width:260px;
      max-height:calc(95vh - 15px); overflow:auto;
      background:var(--panel-grad);border:1px solid #eef2f7;
      border-radius:9.2px;padding:12px;
      box-shadow:0 12px 28px rgba(16,24,40,.14),0 2px 6px rgba(16,24,40,.06);
      font-size:10px; scrollbar-gutter:stable; overscroll-behavior:contain; box-sizing:border-box;
    }
    #controls::-webkit-scrollbar{width:10px}
    #controls::-webkit-scrollbar-track{background:#f3f6fb;border-radius:10px}
    #controls::-webkit-scrollbar-thumb{background:#cfd7e6;border-radius:10px;border:2px solid #f3f6fb}
    #controls::-webkit-scrollbar-thumb:hover{background:#b9c4d8}


    .section{margin-bottom:12px}
    .section-title{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--ink);margin:6px 0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    label.small{font-size:11px;color:#64748b;display:block;margin:4px 0}

    .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:none;border-radius:10px;background:var(--brand-blue);color:#fff;cursor:pointer;transition:.15s;box-shadow:0 4px 14px rgba(37,99,235,.25);font-size:12px}
    .btn:hover{filter:brightness(.96)}
    .btn-ghost{background:#fff;color:var(--ink);border:1px solid var(--ctrl-border);box-shadow:none}
    .btn-danger{background:#ef4444}
    .btn-save{background:#16a34a}

    select,textarea,input[type="text"],input[type="number"],input[type="range"],input[type="color"]{width:100%;box-sizing:border-box;padding:8px;border:1px solid var(--ctrl-border);border-radius:10px;background:#fff;font-size:12px}
    textarea{resize:vertical}

    #toggleButton{position:absolute;top:10px;left:244px;z-index:1001;padding:5px 7px;border:none;border-radius:10px;background:#0f172a;color:#fff;cursor:pointer;font-size:12px}

    #shapeToolbar{position:absolute;right:12px;bottom:12px;z-index:1000;width:320px;display:none;cursor:default;background:#ffffffd8;backdrop-filter:blur(6px);border:1px solid var(--card-border);border-radius:16px;box-shadow:0 12px 28px rgba(16,24,40,.14),0 2px 6px rgba(16,24,40,.06)}
    #shapeToolbar.dragging{opacity:.96}
    #dragHandle{position:sticky;top:0;z-index:3;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px;color:#fff;border-top-left-radius:16px;border-top-right-radius:16px;user-select:none;cursor:move;background:linear-gradient(90deg,var(--brand-blue),var(--brand-blue-dark))}
    #dragHandle .toolbar-title{font-weight:900;font-size:14px;letter-spacing:.2px}
    #btnCloseToolbar{background:rgba(255,255,255,.18);color:#fff;border:none;border-radius:10px;padding:6px 10px;cursor:pointer}
    .toolbar-body{padding:12px;max-height:78vh;overflow:auto}
    .toolbar-body .row{margin:6px 0}

    .actions-bar{position:sticky; top:0; z-index:2; display:flex; gap:8px; padding-bottom:10px; margin-bottom:10px; background:linear-gradient(180deg,#ffffffd8 60%, rgba(255,255,255,0) 100%); border-bottom:1px dashed var(--ctrl-border)}
    .actions-bar .btn{flex:1; justify-content:center; border-radius:12px}

    .field{margin:10px 0}
    .field label.small{margin-bottom:6px}
    .color-row{display:flex;align-items:center;gap:8px}
    .color-row input[type="color"]{padding:0;width:48px;height:36px;border-radius:10px;border:1px solid var(--ctrl-border);background:
      linear-gradient(45deg,#ccc 25%, transparent 25%) 0 0/10px 10px,
      linear-gradient(-45deg,#ccc 25%, transparent 25%) 0 0/10px 10px,
      linear-gradient(45deg,transparent 75%, #ccc 75%) 0 0/10px 10px,
      linear-gradient(-45deg,transparent 75%, #ccc 75%) 0 0/10px 10px,#fff;}
    .hex-badge{font-size:12px;padding:6px 8px;border:1px solid var(--ctrl-border);border-radius:10px;background:#fff;color:#111827;min-width:86px;text-align:center}
    .range-line{display:flex;align-items:center;gap:8px}
    .range-line output{min-width:64px;text-align:center;font-weight:700;font-variant-numeric:tabular-nums;border:1px solid var(--ctrl-border);background:#fff;color:#111827;border-radius:10px;padding:6px 8px;font-size:12px}

    #loadingMessage{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:2000;background:rgba(2,6,23,.82);color:#fff;padding:12px 16px;border-radius:12px;font-size:13px;display:none;box-shadow:0 10px 24px rgba(0,0,0,.35)}
    #fatalError{position:fixed;left:50%;top:12px;transform:translateX(-50%);z-index:3000;background:#ef4444;color:#fff;padding:10px 14px;border-radius:10px;display:none;font-size:13px}

    .label-marker .bubble{position:relative;left:50%;transform:translate(-50%,-100%);display:inline-block;border-radius:8px;white-space:nowrap;line-height:1.15}
    .emoji-pin{background:transparent!important;border:none!important}
    .emoji-pin .emoji{position:relative;left:50%;transform:translate(-50%,-100%);display:inline-block;line-height:1}

    #extentInfo{margin-top:8px;padding-top:8px;border-top:1px dashed var(--ctrl-border);display:none;font-size:12px;color:#111827}
    #extentInfo .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 10px}
    #extentInfo .tag{font-size:11px;color:var(--muted);align-self:center}
    .adjust-mode #map{cursor:move!important}

    .label-editor{position:absolute;z-index:2001;padding:6px;background:#0f172a;color:#fff;border:1px solid var(--brand-blue);border-radius:10px;box-shadow:0 12px 28px rgba(0,0,0,.35)}
    .label-editor input{width:240px;background:transparent;border:0;outline:none;color:#fff;font:13px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}

    #hudStack{display:flex;flex-direction:column;align-items:flex-end;gap:10px;pointer-events:none;margin:10px}
    #hudStack>*{pointer-events:auto}
    .hud-card{background:var(--hud-bg);color:var(--hud-fg);border:1px solid var(--hud-border);border-radius:14px;backdrop-filter:blur(8px);box-shadow:var(--hud-shadow1),var(--hud-shadow2);width:280px;transition:transform .15s,opacity .15s;opacity:.95}
    @media (hover:hover){.hud-card:not(:hover){opacity:.88;transform:scale(.985)}}
    #coordBox{padding:8px!important}
    #coordBox .coord-row{display:flex;gap:6px;align-items:center}
    #coordBox .coord-small{color:#cbd5e1!important;font-size:12px}
    #coordMain{font-weight:800;font-size:10px}
    #coordZoom{font-weight:700}
    #coordState{margin-left:4px}
    .coord-btn{padding:8px 10px!important;border-radius:10px;border:1px solid var(--hud-chip-bd)!important;background:var(--hud-chip-bg)!important;color:var(--hud-fg)!important;cursor:pointer}
    /* HUD colorido (pedido): */
    #lockBtn{border-color:transparent!important;background:linear-gradient(90deg,#0ea5e9,#0284c7)!important;color:#fff!important;box-shadow:0 6px 16px rgba(2,132,199,.35)}
    #lockBtn.active{background:linear-gradient(90deg,#22c55e,#16a34a)!important;box-shadow:0 6px 16px rgba(22,163,74,.35)}
    #copyBtn{border-color:transparent!important;background:linear-gradient(90deg,#f59e0b,#d97706)!important;color:#111827!important;box-shadow:0 6px 16px rgba(217,119,6,.35)}
    #openToolbarBtn{border-color:transparent!important;background:linear-gradient(90deg,#ef4444,#dc2626)!important;color:#fff!important;box-shadow:0 6px 16px rgba(239,68,68,.35)}

    #rulerBox{display:flex;align-items:flex-start;gap:8px;padding:8px;justify-content: space-between}
    .ruler-btn{border-radius:10px;padding:6px 10px;border:1px solid var(--hud-chip-bd);background:var(--hud-chip-bg);color:var(--hud-fg)}
    .ruler-btn i{margin-right:6px}
    #rulerBtn.active{background:linear-gradient(90deg,#1d4ed8,#2563eb);border-color:transparent;color:#fff;box-shadow:0 4px 14px rgba(37,99,235,.35)}
    #rulerValue{font-weight:900;font-variant-numeric:tabular-nums;padding:4px 10px;border-radius:10px;background:var(--hud-chip-bg);border:1px solid var(--hud-chip-bd)}

    #sec-search .row{display:flex;gap:8px;align-items:center}
    #searchBox{flex:1;min-width:0}
    #searchBtn,#gpsBtn{white-space:nowrap}

    #pixCard{position:fixed;right:16px;bottom:16px;z-index:2001;width:300px;background:#fff;border:1px solid var(--card-border);border-radius:10px;box-shadow:0 18px 40px rgba(16,24,40,.18),0 4px 14px rgba(16,24,40,.08);display:none;overflow:hidden;animation:pixIn .25s ease}
    @keyframes pixIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    #pixCard header{background:linear-gradient(90deg,var(--brand-blue),var(--brand-blue-dark));color:#fff;padding:12px;display:flex;align-items:center;justify-content:space-between}
    #pixCard .title{font-weight:800;letter-spacing:.2px}
    #pixCard .body{padding:12px;color:var(--ink)}
    #pixCard .qr{border:1px solid var(--ctrl-border);border-radius:12px;padding:8px;display:flex;align-items:center;justify-content:center;background:#fff}
    #pixCard .kvs{margin-top:8px;font-size:12.5px;color:#111827}
    #pixCard .kv{display:flex;gap:8px;margin:4px 0}
    #pixCard .k{width:96px;color:#64748b}
    #pixCard .v{flex:1;word-break:break-word}
    #pixClose{background:rgba(255,255,255,.22);border:0;color:#fff;padding:6px 8px;border-radius:8px;cursor:pointer}
    #pixActions{display:flex;gap:8px;margin-top:10px}
    #pixActions .btn{flex:1}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;background:#f1f5ff;border:1px solid #e2e8ff;color:#1d4ed8;border-radius:8px;font-weight:600;font-size:12px}

    /* Remover controle de zoom do Leaflet */
    .leaflet-control-zoom { display: none !important; }

    /* =========================
       🔸 RESPONSIVIDADE MOBILE
       ========================= */
    @media (max-width: 880px){
      #controls{
        position:fixed;
        left:0; right:0; bottom:0; top:auto;
        width:auto; min-width:0; max-width:none;
        max-height:52vh; height:52vh;
        border-radius:16px 16px 0 0;
        padding:14px 14px calc(14px + env(safe-area-inset-bottom,0));
        margin:0;
        box-shadow:0 -10px 28px rgba(16,24,40,.16),0 -2px 6px rgba(16,24,40,.06);
        font-size:12px;
      }
      #toggleButton{
        position:fixed;
        top:auto; bottom:calc(env(safe-area-inset-bottom,0) + 12px);
        left:12px;
        padding:10px 12px;
        border-radius:12px;
        font-size:14px;
        z-index:1100;
      }
      #hudStack{gap:8px;margin:10px}
      .hud-card{width:min(88vw, 320px)}
      #coordMain{font-size:12px}

      #shapeToolbar{
        width:min(96vw, 520px);
        right:2vw; left:auto;
        bottom:calc(12px + env(safe-area-inset-bottom,0));
        border-radius:16px;
      }
      #dragHandle .toolbar-title{font-size:15px}
      .toolbar-body{max-height:65vh}

      #controls.hidden{display:none!important}

      .row{gap:10px}
      #sec-search .row{flex-wrap:nowrap}
      #sec-search #searchBox{min-width:0}
      @media (max-width: 560px){
        #sec-search .row{flex-direction:column;align-items:stretch}
        #sec-search .row .btn{width:100%}
      }

      #sec-pdf .row label.btn,
      #sec-kml .row label.btn,
      #sec-draw .row label.btn,
      #sec-project .row label.btn{flex:1}

      #pixCard{
        width:min(92vw, 420px);
        right:4vw;
        bottom:calc(12px + env(safe-area-inset-bottom,0));
        border-radius:14px;
      }

      .leaflet-control-attribution{font-size:10px}
    }

    @media (max-width: 400px){
      #shapeToolbar{width:96vw; right:2vw; left:2vw}
      .actions-bar .btn{font-size:12px;padding:8px}
      .btn{font-size:12px;padding:8px 10px;border-radius:12px}
      select,textarea,input[type="text"],input[type="number"],input[type="range"],input[type="color"]{font-size:13px}
      .section-title{font-size:14px}
    }

    @media (max-height: 520px) and (max-width: 880px){
      #controls{height:46vh;max-height:46vh}
      .toolbar-body{max-height:58vh}
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="loadingMessage">Carregando mapa…</div>
  <div id="fatalError">Falha ao inicializar. Verifique sua internet e recarregue.</div>

  <aside id="controls" aria-label="Painel de controles">
    <section class="section" id="sec-search">
      <div class="section-title"><i class="fa-solid fa-magnifying-glass-location"></i> Buscar</div>
      <div class="row">
        <input id="searchBox" class="coord-input" placeholder="Endereço ou lat,lng (ex.: -5.35758,-49.130495)"/>
        <button id="searchBtn" class="btn">Buscar</button>
        <button id="gpsBtn" class="btn btn-ghost" title="Minha localização"><i class="fa-solid fa-location-crosshairs"></i></button>
      </div>
      <div id="searchResults" class="coord-small" style="margin-top:6px"></div>
    </section>

    <section class="section" id="sec-base">
      <div class="section-title"><i class="fa-solid fa-layer-group"></i> Base</div>
      <label class="small">Mapa base</label>
      <select id="baseSelect">
        <option value="osm">OpenStreetMap</option>
        <option value="gStreets">Google Streets</option>
        <option value="gHybrid">Google Hybrid</option>
        <option value="esriSat">ESRI Satélite</option>
        <option value="osmHOT">OSM Humanitarian</option>
        <option value="openTopo">OpenTopoMap</option>
        <option value="cartoLight">Carto Light</option>
        <option value="cartoDark">Carto Dark</option>
        <option value="cartoVoyager">Carto Voyager</option>
        <option value="esriTopo">ESRI Topográfico</option>
        <option value="esriStreets">ESRI Streets</option>
        <option value="esriTerrain">ESRI Terrain</option>
        <option value="esriHillshade">ESRI Hillshade (relevo)</option>
        <option value="esriImageryClarity">ESRI Satélite (Clarity)</option>
      </select>
      <label class="small"><input type="checkbox" id="chkLabels" /> Rótulos (apenas satélite)</label>
    </section>

    <section class="section" id="sec-pdf">
      <div class="section-title"><i class="fa-solid fa-file-pdf"></i> Cartas (PDF)</div>
      <div class="row" style="gap:8px;">
        <label class="btn btn-ghost" style="flex:1">
          <i class="fas fa-file-pdf"></i> Carregar MPS
          <input type="file" id="pdfInput" accept=".pdf" style="display:none" multiple/>
        </label>
      </div>
      <div id="pdfControls" style="margin-top:6px;"></div>
    </section>

    <section class="section" id="sec-kml">
      <div class="section-title"><i class="fa-solid fa-file-import"></i> KML</div>
      <div class="row">
        <label class="btn btn-ghost" style="flex:1">
          <i class="fas fa-file-alt"></i> Carregar
          <input type="file" id="kmlInput" accept=".kml,.kmz" multiple style="display:none"/>
        </label>
        <button class="btn btn-danger" id="clearKML" title="Limpar"><i class="fas fa-trash"></i></button>
      </div>
      <div id="kmlList" class="coord-small" style="margin-top:8px"></div>
    </section>

    <section class="section" id="sec-draw">
      <div class="section-title"><i class="fa-solid fa-draw-polygon"></i> Formas</div>
      <div class="row">
        <button class="btn btn-ghost" id="btnPoly"   title="Polígono"><i class="fa-solid fa-draw-polygon"></i></button>
        <button class="btn btn-ghost" id="btnRect"   title="Retângulo"><i class="fa-regular fa-square"></i></button>
        <button class="btn btn-ghost" id="btnLine"   title="Linha"><i class="fa-solid fa-slash"></i></button>
        <button class="btn btn-ghost" id="btnCircle" title="Círculo"><i class="fa-regular fa-circle"></i></button>
        <button class="btn btn-ghost" id="btnMarker" title="Ponto"><i class="fa-solid fa-location-dot"></i></button>
      </div>
      <div class="row" style="margin-top:6px;">
        <label class="btn btn-ghost" style="flex:1">
          <i class="fas fa-file-upload"></i> Importar GeoJSON
          <input type="file" id="geojsonInput" accept=".geojson,.json" style="display:none" multiple/>
        </label>
        <button id="exportGeoJSON" class="btn" style="flex:1"><i class="fas fa-download"></i> Salvar GeoJSON</button>
      </div>
    </section>

    <section class="section" id="sec-project">
      <div class="section-title"><i class="fa-solid fa-folder-tree"></i> Projeto</div>
      <div class="row">
        <button id="btnSaveProject" class="btn" style="flex:1"><i class="fa-solid fa-floppy-disk"></i> Salvar projeto</button>
        <label class="btn btn-ghost" style="flex:1">
          <i class="fa-solid fa-file-import"></i> Importar projeto
          <input type="file" id="projectInput" accept=".agromap.json,application/json" style="display:none"/>
        </label>
      </div>
    </section>
  </aside>

  <button id="toggleButton" title="Mostrar/ocultar painel"><i class="fas fa-sliders-h"></i></button>

  <div class="leaflet-bottom leaflet-right">
    <div id="hudStack">
      <div id="rulerBox" class="leaflet-control hud-card">
        <button id="rulerBtn" class="ruler-btn" title="Medir distâncias"><i class="fa-solid fa-ruler"></i> Régua</button>
        <div class="ruler-value" id="rulerValue">0 m</div>
        <button id="rulerClear" class="ruler-btn" title="Limpar medição"><i class="fa-solid fa-eraser"></i> Limpar</button>
      </div>

      <div id="coordBox" class="leaflet-control hud-card">
        <div class="coord-row">
          <button id="lockBtn" class="coord-btn" title="Fixar/Desfixar cruz"><i class="fa-solid fa-thumbtack"></i></button>
          <div class="grow">
            <div id="coordMain">—</div>
            <div class="coord-small">Zoom: <span id="coordZoom">—</span> <span id="coordState"></span></div>
          </div>
          <button id="copyBtn" class="coord-btn" title='Copiar "lat,lng"'><i class="fa-solid fa-copy"></i></button>
          <button id="openToolbarBtn" class="coord-btn" title="Abrir Edição e Seleção"><i class="fa-solid fa-pen"></i></button>
        </div>
      </div>
    </div>
  </div>

  <div id="pixCard" role="dialog" aria-live="polite" aria-label="Apoie a manutenção via PIX">
    <header>
      <span class="title"><i class="fa-solid fa-hand-holding-heart"></i> Apoie a manutenção do Site</span>
      <button id="pixClose" title="Fechar"><i class="fa-solid fa-xmark"></i></button>
    </header>
    <div class="body">
      <div class="chip"><i class="fa-solid fa-bolt"></i> PIX instantâneo</div>
      <div class="qr" style="margin-top:30px"><div id="pixQrBox" aria-hidden="true"></div></div>
      <div class="kvs">
        <div class="kv"><div class="k">Ou use a chave</div><div class="v"><b>Chave Pix</b> — <em>Chave Aleatória</em></div></div>
        <div class="kv"><div class="k">Nome</div><div class="v">Rafael Lima Oliveira</div></div>
        <div class="kv"><div class="k">CPF</div><div class="v">•••.006.732-••</div></div>
        <div class="kv"><div class="k">Banco</div><div class="v">260 - Nu Pagamentos S.A. - Instituição de Pagamento</div></div>
        <div class="kv"><div class="k">Identificador</div><div class="v">EfGWzAFK6b</div></div>
      </div>
      <div id="pixActions">
        <button id="btnCopyPayload" class="btn"><i class="fa-regular fa-copy"></i> Copiar código</button>
        <button id="btnCopyKey" class="btn btn-ghost"><i class="fa-regular fa-copy"></i> Copiar chave</button>
      </div>
      <div class="coord-small" style="margin-top:1px;color:var(--muted)">Escaneie o QR ou use “Copiar código”.</div>
    </div>
  </div>

  <div id="shapeToolbar" aria-live="polite">
    <div id="dragHandle">
      <div class="toolbar-title">Edição e Seleção</div>
      <button id="btnCloseToolbar" title="Fechar">✖</button>
    </div>

    <div class="toolbar-body">
      <div class="actions-bar">
        <button class="btn" id="btnEdit"   title="Editar"><i class="fa-solid fa-pen"></i></button>
        <button class="btn btn-danger" id="btnDelete" title="Excluir"><i class="fa-solid fa-trash"></i></button>
        <button class="btn btn-save" id="btnSaveEdits" title="Salvar edição"><i class="fa-solid fa-floppy-disk"></i></button>
      </div>

      <div class="field">
        <label class="small">Cor da borda</label>
        <div class="color-row"><input type="color" id="strokeColor" value="#1f2937"/><div class="hex-badge" id="strokeHex">#1F2937</div></div>
      </div>

      <div class="field">
        <label class="small">Cor de preenchimento</label>
        <div class="color-row"><input type="color" id="fillColor" value="#60a5fa"/><div class="hex-badge" id="fillHex">#60A5FA</div></div>
      </div>

      <div class="field">
        <label class="small">Espessura</label>
        <div class="range-line"><input type="range" id="strokeWeight" min="1" max="8" value="2"/><output id="strokeWeightOut">2 px</output></div>
      </div>

      <div class="field">
        <label class="small">Opacidade do preenchimento</label>
        <div class="range-line"><input type="range" id="fillOpacity" min="0" max="1" step="0.05" value="0.25"/><output id="fillOpacityOut">0.25</output></div>
      </div>

      <div class="field">
        <label class="small">Etiqueta (uma linha)</label>
        <textarea id="labelText" rows="2" placeholder="Talhão / Safra / Obs."></textarea>
      </div>

      <div class="row">
        <div style="flex:1">
          <label class="small">Tamanho</label>
          <div class="range-line"><input type="range" id="labelSize" min="10" max="28" value="12"/><output id="labelSizeOut">12 px</output></div>
        </div>
        <div style="width:110px">
          <label class="small">Cor</label>
          <div class="color-row"><input type="color" id="labelColor" value="#111827"/></div>
        </div>
      </div>

      <div class="field">
        <label class="small">Fonte</label>
        <select id="labelFont">
          <option value="system-ui,-apple-system,Segoe UI,Roboto,Ubuntu">Padrão (sistema)</option>
          <option value="Arial, Helvetica, sans-serif">Arial</option>
          <option value="'Segoe UI', Tahoma, Geneva, Verdana, sans-serif">Segoe UI</option>
          <option value="'Roboto', 'Helvetica Neue', sans-serif">Roboto</option>
          <option value="Georgia, 'Times New Roman', serif">Serif</option>
          <option value="'Courier New', Courier, monospace">Monospace</option>
        </select>
      </div>

      <div class="row" style="align-items:center">
        <label class="small" style="margin:0;display:flex;gap:6px;align-items:center"><input type="checkbox" id="labelNoBg"/> Sem fundo</label>
        <div style="margin-left:auto;width:110px">
          <label class="small">Fundo</label>
          <div class="color-row"><input type="color" id="labelBgColor" value="#ffffff"/></div>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="btnApplyLabel" title="Criar/atualizar etiqueta"><i class="fa-solid fa-tag"></i> Aplicar/Atualizar</button>
        <button class="btn btn-ghost" id="btnAddFreeLabel" title="Criar etiqueta sem selecionar"><i class="fa-regular fa-square-plus"></i> Etiqueta livre</button>
      </div>

      <div class="field">
        <label class="small">Ícone para ponto</label>
        <select id="markerIcon">
          <option value="pin">📍 Pino</option><option value="tractor">🚜 Trator</option>
          <option value="fazenda">🏡 Fazenda</option><option value="sementes">🌱 Sementes</option>
          <option value="colheita">🌾 Colheita</option><option value="insumo">🧪 Insumo</option>
          <option value="pulverizacao">🛩️ Pulverização</option><option value="praga">🐛 Praga</option>
          <option value="besouro">🪲 Besouro</option><option value="gafanhoto">🦗 Gafanhoto</option>
          <option value="fogo">🔥 Fogo</option><option value="abrigo">⛺ Abrigo</option>
          <option value="agua">💧 Água</option><option value="alerta">⚠️ Alerta</option>
          <option value="posto">🏣 Posto</option><option value="hospital">🏥 Saúde</option>
          <option value="galpao">🏚️ Galpão</option><option value="arvore">🌳 Árvore</option>
          <option value="pedra">🪨 Rocha</option>
        </select>
      </div>
      <div class="row">
        <button class="btn" id="btnAddPoint" title="Adicionar ponto"><i class="fa-solid fa-location-dot"></i> Adicionar ponto</button>
        <button class="btn btn-ghost" id="btnApplyIcon" title="Aplicar no ponto selecionado"><i class="fa-solid fa-wand-magic-sparkles"></i> Aplicar no ponto</button>
      </div>

      <div id="extentInfo">
        <div class="section-title" style="margin-top:2px;"><i class="fa-regular fa-compass"></i> Extent do mapa</div>
        <div class="row" style="margin-bottom:6px;">
          <select id="pdfSelect" style="flex:1" title="Carta ativa"></select>
          <label class="small" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="lockPdf"/> Travar</label>
        </div>
        <div class="grid">
          <div class="tag">Oeste (Lon mín)</div><input id="extW"/>
          <div class="tag">Sul (Lat mín)</div><input id="extS"/>
          <div class="tag">Leste (Lon máx)</div><input id="extE"/>
          <div class="tag">Norte (Lat máx)</div><input id="extN"/>
        </div>
        <div class="row" style="margin-top:8px;">
          <button class="btn btn-ghost" id="btnAdjustPdf" title="Arrastar carta"><i class="fa-solid fa-arrows-up-down-left-right"></i> Ajustar</button>
          <button class="btn" id="btnApplyPdf" title="Aplicar bounds"><i class="fa-solid fa-check"></i> Aplicar</button>
          <button class="btn btn-danger" id="btnCancelAdjust" title="Cancelar"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.addEventListener('load', function(){
      try{
        (()=>{ 'use strict';

    const el = (id) => document.getElementById(id);
    const E = {
      map:null, drawn:null, editSession:null,
      toolbar:el('shapeToolbar'),
      pdfLayers:{}, activePdf:null, lastPdfBounds:null,
      kmlTexts:[],
      kmlLayers:{},
      routeLines:[], decorators:[], startMk:[], endMk:[],
      measure:{on:false,line:null,points:[],layer:L.layerGroup(),hasTemp:false},
      coord:{locked:false,fixed:null,cross:null}
    };
    const UI = {
      baseSelect:el('baseSelect'), chkLabels:el('chkLabels'), togglePanel:el('toggleButton'),
      searchBox:el('searchBox'), searchBtn:el('searchBtn'), gpsBtn:el('gpsBtn'), searchResults:el('searchResults'),
      pdfInput:el('pdfInput'), pdfControls:el('pdfControls'), pdfSelect:el('pdfSelect'),
      extW:el('extW'),extS:el('extS'),extE:el('extE'),extN:el('extN'),
      lockPdf:el('lockPdf'), btnAdjustPdf:el('btnAdjustPdf'), btnApplyPdf:el('btnApplyPdf'), btnCancelAdjust:el('btnCancelAdjust'),
      kmlInput:el('kmlInput'), clearKML:el('clearKML'),
      btnPoly:el('btnPoly'), btnRect:el('btnRect'), btnLine:el('btnLine'), btnCircle:el('btnCircle'), btnMarker:el('btnMarker'),
      strokeColor:el('strokeColor'), fillColor:el('fillColor'), strokeWeight:el('strokeWeight'), fillOpacity:el('fillOpacity'),
      strokeHex:el('strokeHex'), fillHex:el('fillHex'), strokeWeightOut:el('strokeWeightOut'), fillOpacityOut:el('fillOpacityOut'),
      labelText:el('labelText'), labelSize:el('labelSize'), labelSizeOut:el('labelSizeOut'),
      labelColor:el('labelColor'), labelFont:el('labelFont'), labelNoBg:el('labelNoBg'), labelBg:el('labelBgColor'),
      btnApplyLabel:el('btnApplyLabel'), btnAddFreeLabel:el('btnAddFreeLabel'),
      markerIcon:el('markerIcon'), btnAddPoint:el('btnAddPoint'), btnApplyIcon:el('btnApplyIcon'),
      btnEdit:el('btnEdit'), btnDelete:el('btnDelete'), btnSaveEdits:el('btnSaveEdits'), btnCloseToolbar:el('btnCloseToolbar'), openToolbarBtn:el('openToolbarBtn'),
      exportGeoJSON:el('exportGeoJSON'), geojsonInput:el('geojsonInput'),
      coordMain:el('coordMain'), coordZoom:el('coordZoom'), coordState:el('coordState'), lockBtn:el('lockBtn'), copyBtn:el('copyBtn'),
      rulerBtn:el('rulerBtn'), rulerValue:el('rulerValue'), rulerClear:el('rulerClear'),
      loading:el('loadingMessage'),
      pixCard:el('pixCard'), pixClose:el('pixClose'), pixQrBox:el('pixQrBox'), btnCopyPayload:el('btnCopyPayload'), btnCopyKey:el('btnCopyKey'),
      btnSaveProject:el('btnSaveProject'), projectInput:el('projectInput'),
      kmlList:el('kmlList'),
      fatal:el('fatalError')
    };
    const CONST = {
      ACRES_PER_M2:0.00024710538146717,
      START_ICON:L.icon({iconUrl:'https://img.icons8.com/emoji/48/000000/triangular-flag.png',iconSize:[24,24],iconAnchor:[12,24]}),
      END_ICON:L.icon({iconUrl:'https://img.icons8.com/emoji/48/000000/chequered-flag.png',iconSize:[24,24],iconAnchor:[12,24]}),
      PIX_PAYLOAD:'00020126580014BR.GOV.BCB.PIX013651aeff90-273f-4547-8d78-33d34059010c5204000053039865802BR5920Rafael Lima Oliveira6009SAO PAULO62140510EfGWzAFK6b6304B782',
      PIX_RANDOM_KEY:'51aeff90-273f-4547-8d78-33d34059010c'
    };
    const showLoading=(m='Carregando…')=>{UI.loading.textContent=m;UI.loading.style.display='block'};
    const hideLoading=()=>{UI.loading.style.display='none'};
    const fmtN=(n,d=2)=>Number(n).toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d});
    const escapeHTML = (s) => (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const toHex=(c)=>{if(!c)return'#000000';if(c[0]==='#')return c.toUpperCase();const ctx=document.createElement('canvas').getContext('2d');ctx.fillStyle=c;const m=ctx.fillStyle.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);const h=n=>('0'+(+n).toString(16)).slice(-2);return m?`#${h(m[1])}${h(m[2])}${h(m[3])}`.toUpperCase():'#000000'};

    /* Base */
    const Base=(()=>{
      const osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:23,attribution:'© OpenStreetMap'});
      const gStreets=L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{maxZoom:23,subdomains:['mt0','mt1','mt2','mt3'],attribution:'© Google'});
      const gHybrid=L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:23,subdomains:['mt0','mt1','mt2','mt3'],attribution:'© Google'});
      const esriSat=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:23,attribution:'Tiles © Esri'});
      const esriLbls=L.layerGroup([
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}'),
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Transportation/MapServer/tile/{z}/{y}/{x}')
      ]);
      const osmHOT=L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',{maxZoom:22,attribution:'© OpenStreetMap contributors, HOT'});
      const openTopo=L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17,attribution:'© OpenTopoMap (CC-BY-SA)'});
      const cartoLight=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{maxZoom:22,subdomains:'abcd',attribution:'© OpenStreetMap © CARTO'});
      const cartoDark=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',{maxZoom:22,subdomains:'abcd',attribution:'© OpenStreetMap © CARTO'});
      const cartoVoyager=L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{maxZoom:22,subdomains:'abcd',attribution:'© OpenStreetMap © CARTO'});
      const esriTopo=L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',{maxZoom:22,attribution:'Tiles © Esri — World Topo Map'});
      const esriStreets=L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',{maxZoom:22,attribution:'Tiles © Esri — World Street Map'});
      const esriTerrain=L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}',{maxZoom:13,attribution:'Tiles © Esri — Terrain Base'});
      const esriHillshade=L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}',{maxZoom:22,attribution:'Tiles © Esri — Hillshade'});
      /* CORREÇÃO AQUI: URL com {x} (antes estava {x]) */
      const esriClarity=L.tileLayer('https://clarity.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:22,attribution:'Tiles © Esri — Imagery (Clarity)'});

      const all=[osm,gStreets,gHybrid,esriSat,esriLbls,osmHOT,openTopo,cartoLight,cartoDark,cartoVoyager,esriTopo,esriStreets,esriTerrain,esriHillshade,esriClarity];
      function setBase(name){
        showLoading('Carregando mapa…');
        all.forEach(l=>{try{E.map.removeLayer(l);}catch{}});
        if(name==='osm')E.map.addLayer(osm);
        if(name==='gStreets')E.map.addLayer(gStreets);
        if(name==='gHybrid')E.map.addLayer(gHybrid);
        if(name==='esriSat')E.map.addLayer(esriSat);
        if(name==='osmHOT')E.map.addLayer(osmHOT);
        if(name==='openTopo')E.map.addLayer(openTopo);
        if(name==='cartoLight')E.map.addLayer(cartoLight);
        if(name==='cartoDark')E.map.addLayer(cartoDark);
        if(name==='cartoVoyager')E.map.addLayer(cartoVoyager);
        if(name==='esriTopo')E.map.addLayer(esriTopo);
        if(name==='esriStreets')E.map.addLayer(esriStreets);
        if(name==='esriTerrain')E.map.addLayer(esriTerrain);
        if(name==='esriHillshade')E.map.addLayer(esriHillshade);
        if(name==='esriImageryClarity')E.map.addLayer(esriClarity);
        if((name==='gHybrid'||name==='esriSat'||name==='esriImageryClarity')&&UI.chkLabels.checked)E.map.addLayer(esriLbls);
        setTimeout(hideLoading,300)
      }
      function init(){
        E.map=L.map('map',{maxZoom:23, zoomControl:false}).setView([-2.756,-48.930],12);
        L.control.scale({imperial:false,position:'bottomleft'}).addTo(E.map);
        osm.addTo(E.map);
        UI.baseSelect.addEventListener('change',e=>setBase(e.target.value));
        UI.chkLabels.addEventListener('change',()=>setBase(UI.baseSelect.value));
        UI.togglePanel.addEventListener('click',()=>el('controls').classList.toggle('hidden'));
        setBase('gStreets')
      }
      return{init,setBase};
    })();

    /* Busca */
    const Search=(()=>{
      const parseLatLng=(t)=>{
        const s=t.trim().replace(';',',').replace(/\s+/g,'').replace(/−/g,'-');
        const m=s.match(/^\s*(-?\d+(?:[.,]\d+)?)\s*,\s*(-?\d+(?:[.,]\d+)?)\s*$/);
        if(!m)return null;
        const lat=parseFloat(m[1].replace(',','.'),10),lng=parseFloat(m[2].replace(',','.'),10);
        if(Number.isNaN(lat)||Number.isNaN(lng)||lat<-90||lat>90||lng<-180||lng>180)return null;
        return L.latLng(lat,lng);
      };
      const geocode=async(q)=>{
        const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&addressdetails=1&limit=8`;
        const res=await fetch(url,{headers:{'Accept-Language':'pt-BR'}});return res.json();
      };
      const shortName=(s)=>(s||'').split(',')[0];

      async function doSearch(){
        const q=UI.searchBox.value.trim(); if(!q)return;
        const ll=parseLatLng(q);
        if(ll){E.map.setView(ll,Math.max(14,E.map.getZoom())); Coord.fixAt(ll); UI.searchResults.innerHTML=''; return;}
        UI.searchResults.textContent='Buscando…';
        try{
          const list=await geocode(q);
          if(!list.length){UI.searchResults.textContent='Nada encontrado.';return;}
          UI.searchResults.innerHTML=list.map(it=>`
            <div style="margin:6px 0">
              <a href="#" data-lat="${it.lat}" data-lon="${it.lon}" data-bbox="${(it.boundingbox||[]).join('|')}">
                <b>${shortName(it.display_name)}</b><br/><span class="coord-small">${it.display_name}</span>
              </a>
            </div>`).join('');
        }catch{UI.searchResults.textContent='Falha na busca.'}
      }
      function bind(){
        UI.searchBtn.addEventListener('click',doSearch);
        UI.searchBox.addEventListener('keydown',e=>{if(e.key==='Enter')doSearch();});
        UI.searchResults.addEventListener('click',e=>{
          const a=e.target.closest('a[data-lat]'); if(!a)return; e.preventDefault();
          const lat=parseFloat(a.dataset.lat),lon=parseFloat(a.dataset.lon);
          const bbox=(a.dataset.bbox||'').split('|').map(Number);
          if(bbox.length===4&&bbox.every(x=>!Number.isNaN(x))){
            const b=L.latLngBounds([[bbox[0],bbox[2]],[bbox[1],bbox[3]]]);
            E.map.fitBounds(b,{padding:[16,16]});
          }else{E.map.setView([lat,lon],16);}
          Coord.fixAt(L.latLng(lat,lon)); UI.searchResults.innerHTML='';
        });
        UI.gpsBtn.addEventListener('click',()=>{
          if(!navigator.geolocation)return alert('Geolocalização não suportada');
          navigator.geolocation.getCurrentPosition(
            p=>{const ll=L.latLng(p.coords.latitude,p.coords.longitude);E.map.setView(ll,16);Coord.fixAt(ll);},
            ()=>alert('Não foi possível obter sua localização.'));
        });
      }
      return{bind};
    })();

    /* PDFs */
    const PDF=(()=>{
      let adjustRect=null,refRect=null,dragging=false,startLatLng=null,startBounds=null;
      const fmt6=(n)=>(+n).toFixed(6);
      const setInputsFromBounds=(b)=>{UI.extW.value=fmt6(b.getWest());UI.extS.value=fmt6(b.getSouth());UI.extE.value=fmt6(b.getEast());UI.extN.value=fmt6(b.getNorth());};
      const freeze=(on)=>{
        if(on){E.map.dragging.disable();E.map.scrollWheelZoom.disable();E.map.doubleClickZoom.disable();E.map.boxZoom.disable();E.map.touchZoom.disable();E.map.keyboard.disable();document.body.classList.add('adjust-mode');}
        else {E.map.dragging.enable();E.map.scrollWheelZoom.enable();E.map.doubleClickZoom.enable();E.map.boxZoom.enable();E.map.touchZoom.enable();E.map.keyboard.enable();document.body.classList.remove('adjust-mode');}
      };
      function refreshSelect(){
        UI.pdfSelect.innerHTML='';
        const names=Object.keys(E.pdfLayers);
        names.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;UI.pdfSelect.appendChild(o);});
        if(names.length){
          if(!E.activePdf||!E.pdfLayers[E.activePdf])E.activePdf=names[names.length-1];
          UI.pdfSelect.value=E.activePdf; updateInputs();
          document.getElementById('extentInfo').style.display='block';
        } else document.getElementById('extentInfo').style.display='none';
      }
      function updateInputs(){const lyr=E.pdfLayers[E.activePdf]; if(!lyr)return; setInputsFromBounds(lyr.getBounds());}
      function addOpacityControl(name){
        const wrap=UI.pdfControls; const row=document.createElement('div');
        row.style.cssText='display:grid;grid-template-columns:140px 44px auto;row-gap:4px;column-gap:8px;align-items:center;margin:6px 0';
        row.innerHTML=`
          <div style="grid-column:1/-1;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${name}</div>
          <input class="rng" type="range" min="0" max="1" step="0.1" value="${E.pdfLayers[name]._opacity||1}" style="grid-column:1/2;margin:0">
          <div class="pct" style="grid-column:2/3;font-size:11px;color:#6b7280;text-align:right">${Math.round((E.pdfLayers[name]._opacity||1)*100)}%</div>
          <button class="btn btn-danger" title="Remover" style="grid-column:3/4;justify-self:end"><i class="fas fa-trash"></i></button>`;
        const range=row.querySelector('.rng'),pct=row.querySelector('.pct'),del=row.querySelector('button');
        range.oninput=()=>{if(E.pdfLayers[name]){E.pdfLayers[name].setOpacity(range.value); E.pdfLayers[name]._opacity=+range.value; pct.textContent=Math.round(range.value*100)+'%';}};
        del.onclick=()=>{cleanupAdjust();const lyr=E.pdfLayers[name]; if(lyr){try{E.map.removeLayer(lyr);}catch{} delete E.pdfLayers[name];} row.remove(); if(E.activePdf===name)E.activePdf=null; refreshSelect();};
        wrap.appendChild(row);
      }
      function cleanupAdjust(){
        if(adjustRect){
          const{onDown,onMove,onUp}=adjustRect._handlers||{};
          E.map.off('mousedown',onDown);E.map.off('mousemove',onMove);E.map.off('mouseup',onUp);
          E.map.removeLayer(adjustRect);adjustRect=null;
        }
        if(refRect){E.map.removeLayer(refRect);refRect=null;}
        dragging=false;startLatLng=null;startBounds=null;freeze(false);
      }
      function uniqueName(name){if(!E.pdfLayers[name])return name;let i=2;const base=name.replace(/(\.pdf)$/i,'');const ext=name.match(/\.pdf$/i)?'.pdf':'';while(E.pdfLayers[`${base} (${i})${ext}`])i++;return `${base} (${i})${ext}`;}
      function bind(){
        if(window.pdfjsLib){ pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.7.570/pdf.worker.min.js'; }
        UI.pdfInput.addEventListener('change',(e)=>{
          [...e.target.files].forEach(async(file)=>{
            if(file.type!=='application/pdf'){console.warn('PDF inválido:',file.name);return;}
            showLoading('Carregando MPS…');
            try{
              const buf=await file.arrayBuffer();
              const text=new TextDecoder('latin1').decode(new Uint8Array(buf));
              const m=/\/GPTS\s*\[\s*([^\]]+)\]/.exec(text);
              if(!m){console.warn('Nenhum /GPTS em',file.name);return;}
              const coords=Array.from(m[1].matchAll(/[-+]?\d+(?:\.\d+)?/g)).map(x=>+x[0]);
              const latLon=[]; for(let i=0;i+1<coords.length;i+=2)latLon.push([coords[i],coords[i+1]]);
              const lats=latLon.map(c=>c[0]),lons=latLon.map(c=>c[1]);
              const bounds=[[Math.min(...lats),Math.min(...lons)],[Math.max(...lats),Math.max(...lons)]];
              const name=uniqueName(file.name);

              const pdf=await pdfjsLib.getDocument({data:new Uint8Array(buf)}).promise;
              const page=await pdf.getPage(1);
              const viewport=page.getViewport({scale:3});
              const canvas=document.createElement('canvas'),ctx=canvas.getContext('2d');
              canvas.height=viewport.height;canvas.width=viewport.width;
              await page.render({canvasContext:ctx,viewport}).promise;
              const url=canvas.toDataURL();

              if(E.pdfLayers[name])E.map.removeLayer(E.pdfLayers[name]);
              const ov=L.imageOverlay(url,bounds,{opacity:1}).addTo(E.map);
              ov._dataUrl=url; ov._opacity=1; E.pdfLayers[name]=ov; E.activePdf=name;
              addOpacityControl(name); refreshSelect();

              E.map.fitBounds(bounds,{padding:[16,16]}); E.toolbar.style.display='block';
            }catch(err){console.error('Falha PDF',file.name,err);}
            finally{hideLoading();cleanupAdjust();}
          });
        });

        UI.pdfSelect.addEventListener('change',()=>{cleanupAdjust();E.activePdf=UI.pdfSelect.value;updateInputs();});

        UI.btnAdjustPdf.addEventListener('click',()=>{
          if(UI.lockPdf.checked)return;
          const lyr=E.pdfLayers[E.activePdf]; if(!lyr||adjustRect)return;
          freeze(true);
          const b=lyr.getBounds();
          adjustRect=L.rectangle(b,{color:'#2563eb',weight:2,fillOpacity:.08,fillColor:'#60a5fa',dashArray:'6,6',interactive:false}).addTo(E.map);
          refRect   =L.rectangle(b,{color:'#ef4444',weight:2,fillOpacity:0,dashArray:'4,6',interactive:false}).addTo(E.map);
          dragging=false; startBounds=b;
          const onDown=(ev)=>{dragging=true;startLatLng=ev.latlng};
          const onMove=(ev)=>{
            if(!dragging||!adjustRect)return;
            const dLat=ev.latlng.lat-startLatLng.lat,dLng=ev.latlng.lng-startLatLng.lng;
            const nb=L.latLngBounds([[startBounds.getSouth()+dLat,startBounds.getWest()+dLng],[startBounds.getNorth()+dLat,startBounds.getEast()+dLng]]);
            adjustRect.setBounds(nb); lyr.setBounds(nb); setInputsFromBounds(nb);
          };
          const onUp=()=>{if(dragging){dragging=false;startBounds=adjustRect.getBounds();}};
          E.map.on('mousedown',onDown);E.map.on('mousemove',onMove);E.map.on('mouseup',onUp);
          adjustRect._handlers={onDown,onMove,onUp};
        });

        UI.btnApplyPdf.addEventListener('click',()=>{
          const lyr=E.pdfLayers[E.activePdf]; if(!lyr)return;
          const w=parseFloat(UI.extW.value),s=parseFloat(UI.extS.value),e=parseFloat(UI.extE.value),n=parseFloat(UI.extN.value);
          const b=(isFinite(w)&&isFinite(s)&&isFinite(e)&&isFinite(n))?L.latLngBounds([[s,w],[n,e]]):(adjustRect?adjustRect.getBounds():null); if(!b)return;
          lyr.setBounds(b); cleanupAdjust(); updateInputs();
        });
        UI.btnCancelAdjust.addEventListener('click',()=>{cleanupAdjust();updateInputs();});
      }
      return{bind,addOpacityControl,refreshSelect};
    })();

    /* KML – EDITÁVEL + CAMADAS MULTI-ARQUIVO (com suporte a KMZ) */
    const KML=(()=>{
      function clear(){
        Object.values(E.kmlLayers).forEach(info=>{
          info.layers.forEach(l=>{
            try{ E.drawn.removeLayer(l); }catch{}
          });
        });
        E.routeLines.forEach(l=>{try{E.map.removeLayer(l);}catch{}});
        E.decorators.forEach(d=>{try{E.map.removeLayer(d);}catch{}});
        E.startMk.forEach(m=>{try{E.map.removeLayer(m);}catch{}});
        E.endMk.forEach(m=>{try{E.map.removeLayer(m);}catch{}});
        E.routeLines=[];E.decorators=[];E.startMk=[];E.endMk=[];
        E.kmlTexts=[];
        E.kmlLayers={};
        if(UI.kmlList) UI.kmlList.innerHTML='';
      }

      function renderKmlList(){
        if(!UI.kmlList) return;
        const names=Object.keys(E.kmlLayers);
        if(!names.length){ UI.kmlList.innerHTML=''; return; }
        UI.kmlList.innerHTML = names.map(n=>{
          const id='kml_vis_'+n.replace(/[^\w-]/g,'_');
          const visible=E.kmlLayers[n].visible!==false;
          return `
            <div style="display:flex;align-items:center;gap:6px;margin:4px 0">
              <input type="checkbox" id="${id}" ${visible?'checked':''} data-name="${escapeHTML(n)}" />
              <label for="${id}" style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="${escapeHTML(n)}">${escapeHTML(n)}</label>
              <button class="btn btn-ghost" data-del="${escapeHTML(n)}" title="Remover camada"><i class="fas fa-trash"></i></button>
            </div>`;
        }).join('');

        UI.kmlList.querySelectorAll('input[type=checkbox]').forEach(chk=>{
          chk.addEventListener('change',e=>{
            const name=e.target.dataset.name; setVisibility(name, e.target.checked);
          });
        });
        UI.kmlList.querySelectorAll('button[data-del]').forEach(btn=>{
          btn.addEventListener('click',e=>{
            const name=e.currentTarget.dataset.del; removeLayer(name);
          });
        });
      }

      function setVisibility(name, visible){
        const entry=E.kmlLayers[name]; if(!entry) return;
        entry.visible = !!visible;
        entry.layers.forEach(l=>{
          try{
            if(l.setStyle){ l.setStyle({opacity: visible? (l.options.opacity ?? 1) : 0, fillOpacity: visible? (l.options.fillOpacity ?? 0.25) : 0}); }
            if(l.setOpacity){ l.setOpacity(visible? (l.options.opacity ?? 1) : 0); }
            if(l._icon){ l._icon.style.display = visible? '' : 'none'; }
            if(l._path){ l._path.style.display = visible? '' : 'none'; }
          }catch{}
        });
      }

      function removeLayer(name){
        const entry=E.kmlLayers[name]; if(!entry) return;
        entry.layers.forEach(l=>{
          try{ E.drawn.removeLayer(l); }catch{}
        });
        delete E.kmlLayers[name];
        renderKmlList();
      }

      async function readKmlOrKmz(file){
        const isKmz = /\.kmz$/i.test(file.name) || /kmz|zip/.test(file.type||'');
        if(!isKmz){
          try{ return await file.text(); }
          catch{
            const buf = await file.arrayBuffer();
            return new TextDecoder('utf-8').decode(buf);
          }
        }
        const buf = await file.arrayBuffer();
        const zip = await JSZip.loadAsync(buf);
        let entry = zip.file(/(^|\/)doc\.kml$/i)[0] || zip.file(/\.kml$/i)[0];
        if(!entry) throw new Error('KMZ sem arquivo .kml interno');
        return await entry.async('string');
      }

      function bind(){
        UI.kmlInput.addEventListener('change', async(ev)=>{
          if(!ev.target.files?.length) return;
          showLoading('Carregando KML/KMZ…');
          try{
            const files=[...ev.target.files];
            let any=false,totalBounds=null;
            const extendSafe=(b)=>{ if(!b)return; totalBounds = totalBounds ? totalBounds.extend(b) : (b.getSouthWest? L.latLngBounds(b.getSouthWest(),b.getNorthEast()) : L.latLngBounds(b[0],b[1])); };

            for(const f of files){
              let text='';
              try{
                text = await readKmlOrKmz(f);
              }catch(e){
                console.error('Erro lendo arquivo:', f.name, e);
                alert('Falha ao ler '+f.name+': '+(e?.message||e));
                continue;
              }
              E.kmlTexts.push({name:f.name,text});

              const kml=new DOMParser().parseFromString(text,'text/xml');
              const gj=toGeoJSON.kml(kml);
              if(!gj.features.length){ console.warn('KML sem dados:',f.name); continue; }

              if(!E.kmlLayers[f.name]) E.kmlLayers[f.name] = {layers:[], visible:true};

              const layerGroup = L.geoJSON(gj,{
                pointToLayer:(ft,latlng)=> L.marker(latlng,{draggable:true}),
                style:(ft)=>({
                  color: (ft?.properties?.stroke) || '#c53030',
                  weight: (ft?.properties?.['stroke-width']) || 2,
                  fillColor: (ft?.properties?.fill) || '#60a5fa',
                  fillOpacity: Number.isFinite(+ft?.properties?.['fill-opacity']) ? +ft.properties['fill-opacity'] : 0.25,
                  opacity: Number.isFinite(+ft?.properties?.['stroke-opacity']) ? +ft.properties['stroke-opacity'] : 1
                }),
                onEachFeature:(ft,layer)=>{
                  E.kmlLayers[f.name].layers.push(layer);
                  E.drawn.addLayer(layer);
                  Draw.attach(layer);
                  Draw.showInfo(layer);
                  any=true;

                  try{ extendSafe(layer.getBounds()); }
                  catch{
                    if(layer.getLatLng){ extendSafe(L.latLngBounds([layer.getLatLng(),layer.getLatLng()])); }
                  }

                  if(ft.geometry?.type==='LineString' || ft.geometry?.type==='MultiLineString'){
                    try{
                      E.routeLines.push(layer);
                      const deco=L.polylineDecorator(layer,{patterns:[{offset:'3%',repeat:150,symbol:L.Symbol.arrowHead({pixelSize:10,polygon:true,pathOptions:{color:'#dd6b20',fillColor:'#dd6b20',fillOpacity:1,stroke:true}})}]}).addTo(E.map);
                      E.decorators.push(deco);
                      const coords = (ft.geometry.type==='LineString') ? ft.geometry.coordinates : (ft.geometry.coordinates?.[0]||[]);
                      if(coords?.length){
                        const s=L.marker([coords[0][1],coords[0][0]],{icon:CONST.START_ICON}).addTo(E.map);
                        const last=coords[coords.length-1];
                        const e2=L.marker([last[1],last[0]],{icon:CONST.END_ICON}).addTo(E.map);
                        E.startMk.push(s); E.endMk.push(e2);
                        extendSafe(L.latLngBounds([s.getLatLng(),s.getLatLng()]));
                        extendSafe(L.latLngBounds([e2.getLatLng(),e2.getLatLng()]));
                      }
                    }catch{}
                  }
                }
              });

              // Garante bounds mesmo em alguns Multi*
              try{
                if(layerGroup && layerGroup.getLayers().length){
                  extendSafe(layerGroup.getBounds());
                }
              }catch{}
            }

            renderKmlList();
            if(any && totalBounds){ E.map.fitBounds(totalBounds,{padding:[16,16]}); }
          }catch(err){ console.error('Erro KML/KMZ:', err); alert('Falha na importação de KML/KMZ: '+(err?.message||err)); }
          finally{ hideLoading(); }
        });

        UI.clearKML.addEventListener('click', clear);
      }

      function loadFromTextList(list){
        if(!list || !list.length) return;
        const dt = new DataTransfer();
        list.forEach(({name,text})=>{
          const file = new File([text], name || 'arquivo.kml', {type:'application/vnd.google-earth.kml+xml'});
          dt.items.add(file);
        });
        UI.kmlInput.files = dt.files;
        UI.kmlInput.dispatchEvent(new Event('change'));
      }

      return{bind,loadFromTextList,clear,setVisibility,removeLayer};
    })();

    /* Draw / Etiquetas / Emojis */
    const Draw=(()=>{
      let selected=null;
      let activeHandler=null;

      function isLabel(layer){
        return layer instanceof L.Marker && layer.options?.icon?.options?.className==='label-marker';
      }
      function buildLabelIcon(text,opts){
        const style=[
          `font-size:${opts.size}px`,`color:${opts.color}`,`font-family:${opts.font}`,`white-space:nowrap`,`line-height:1.15`,
          opts.noBg ? 'background:transparent;border:0;box-shadow:none;padding:0'
                    : `background:${opts.bgColor};border:1px solid #e5e7eb;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:4px 6px`
        ].join(';');
        return L.divIcon({className:'label-marker',html:`<div class="bubble" style="${style}">${escapeHTML(text||'')}</div>`,iconSize:null,iconAnchor:[0,0]});
      }
      const currentLabelOpts = ()=>({size:+UI.labelSize.value||12,color:UI.labelColor.value||'#111827',font:UI.labelFont.value||"system-ui,-apple-system,Segoe UI,Roboto,Ubuntu",noBg:!!UI.labelNoBg.checked,bgColor:UI.labelBg.value||'#ffffff'});
      const scaledSize=(base,refZoom)=>{const z=E.map.getZoom();const factor=Math.pow(2, z-(refZoom??z));return Math.max(6, Math.min(120, base*factor));};
      const iconFor=(key,sizePx=22)=>{const mapx={pin:'📍',tractor:'🚜',fazenda:'🏡',sementes:'🌱',colheita:'🌾',insumo:'🧪',pulverizacao:'🛩️',praga:'🐛',besouro:'🪲',gafanhoto:'🦗',fogo:'🔥',abrigo:'⛺',agua:'💧',alerta:'⚠️',posto:'🏣',hospital:'🏥',galpao:'🏚️',arvore:'🌳',pedra:'🪨'};const emoji=mapx[key]||'📍';return L.divIcon({html:`<div class="emoji" style="font-size:${sizePx}px">${emoji}</div>`,iconSize:null,iconAnchor:[0,0],className:'emoji-pin'})};

      function attach(layer){
        layer.on('click', ()=> select(layer));
        if(layer instanceof L.Marker){ layer.options.draggable=true; }
        if(isLabel(layer)){
          layer.setZIndexOffset(1000);
          layer.on('dblclick', (ev)=>{ ev.originalEvent?.preventDefault(); ev.originalEvent?.stopPropagation(); LabelEditor.open(layer); });
        }
      }
      function select(layer){
        selected=layer; try{layer.openPopup();}catch{}
        E.toolbar.style.display='block';
        const pos=JSON.parse(sessionStorage.getItem('toolbar_pos')||'null');
        if(pos){ Object.assign(E.toolbar.style,{left:pos.left,top:pos.top,right:'auto',bottom:'auto'}); }
        syncToolbar();
      }
      function updateStyleBadges(){
        if(UI.strokeHex)UI.strokeHex.textContent=toHex(UI.strokeColor.value);
        if(UI.fillHex)UI.fillHex.textContent=toHex(UI.fillColor.value);
        if(UI.strokeWeightOut)UI.strokeWeightOut.textContent=`${UI.strokeWeight.value} px`;
        if(UI.fillOpacityOut)UI.fillOpacityOut.textContent=`${parseFloat(UI.fillOpacity.value).toFixed(2)}`;
        if(UI.labelSizeOut)UI.labelSizeOut.textContent=`${UI.labelSize.value} px`;
      }
      function syncToolbar(){
        updateStyleBadges();
        if(!selected) return;
        if(isLabel(selected)){
          const t=selected.options.htmlText||'';
          const o=selected._labelOpts||currentLabelOpts();
          UI.labelText.value=t;
          UI.labelSize.value=Math.round(selected._baseSizePx||o.size);
          UI.labelSizeOut.textContent=`${UI.labelSize.value} px`;
          UI.labelColor.value=o.color; UI.labelFont.value=o.font; UI.labelNoBg.checked=!!o.noBg; UI.labelBg.value=o.bgColor||'#ffffff';
          return;
        }
        if(selected.options&&selected.setStyle){
          UI.strokeColor.value=toHex(selected.options.color||'#1f2937');
          UI.fillColor.value=toHex(selected.options.fillColor||'#60a5fa');
          UI.strokeWeight.value=selected.options.weight||2;
          UI.fillOpacity.value=(selected.options.fillOpacity!=null?selected.options.fillOpacity:.25);
          updateStyleBadges();
          if(selected._labelRef){
            const t=selected._labelRef.options.htmlText||'';
            const o=selected._labelRef._labelOpts||currentLabelOpts();
            UI.labelText.value=t;
            UI.labelSize.value=Math.round(selected._labelRef._baseSizePx||o.size);
            UI.labelSizeOut.textContent=`${UI.labelSize.value} px`;
            UI.labelColor.value=o.color; UI.labelFont.value=o.font; UI.labelNoBg.checked=!!o.noBg; UI.labelBg.value=o.bgColor||'#ffffff';
          }else UI.labelText.value='';
        }
      }
      function showInfo(layer){
        try{
          const gj=layer.toGeoJSON(); if(!gj.geometry) return;
          const t=gj.geometry.type; let html='';
          if(t==='Polygon'||t==='MultiPolygon'){
            const area_m2=turf.area(gj), area_ha=area_m2/10000, area_km2=area_m2/1e6, acres=area_m2*CONST.ACRES_PER_M2;
            const per_m=turf.length(turf.polygonToLine(gj),{units:'meters'}), per_km=per_m/1000;
            const centroid=turf.centroid(gj).geometry.coordinates;
            const verts=countVerts(gj.geometry);
            const b=layer.getBounds?.();
            let w_km='—', h_km='—';
            if(b){
              const midLat=(b.getSouth()+b.getNorth())/2, midLon=(b.getWest()+b.getEast())/2;
              w_km=turf.distance([b.getWest(),midLat],[b.getEast(),midLat],{units:'kilometers'});
              h_km=turf.distance([midLon,b.getSouth()],[midLon,b.getNorth()],{units:'kilometers'});
            }
            html = `<div style="font-size:13px;line-height:1.35">
              <div><b>Área:</b> ${fmtN(area_m2,0)} m² • ${fmtN(area_ha,4)} ha • ${fmtN(area_km2,4)} km² • ${fmtN(acres,2)} acres</div>
              <div><b>Perímetro:</b> ${fmtN(per_m,1)} m • ${fmtN(per_km,4)} km</div>
              <div><b>Vértices:</b> ${verts}</div>
              <div><b>Centro:</b> ${fmtN(centroid[1],6)}, ${fmtN(centroid[0],6)}</div>
              <div><b>BBox:</b> ${typeof w_km==='number'?fmtN(w_km,3):w_km} km × ${typeof h_km==='number'?fmtN(h_km,3):h_km} km</div>
            </div>`;
          } else if(t==='LineString'||t==='MultiLineString'){
            const len_km=turf.length(gj,{units:'kilometers'}), len_m=len_km*1000, len_mi=turf.length(gj,{units:'miles'}), verts=countVerts(gj.geometry);
            html=`<div style="font-size:13px;line-height:1.35">
              <div><b>Comprimento:</b> ${fmtN(len_m,1)} m • ${fmtN(len_km,3)} km • ${fmtN(len_mi,3)} mi</div>
              <div><b>Segmentos:</b> ${verts}</div>
            </div>`;
          } else if(layer instanceof L.Circle){
            const r=layer.getRadius(); const area_m2=Math.PI*r*r, area_ha=area_m2/10000, area_km2=area_m2/1e6, circ=2*Math.PI*r; const c=layer.getLatLng();
            html=`<div style="font-size:13px;line-height:1.35">
              <div><b>Raio:</b> ${fmtN(r,1)} m</div>
              <div><b>Circunferência:</b> ${fmtN(circ,1)} m</div>
              <div><b>Área:</b> ${fmtN(area_m2,0)} m² • ${fmtN(area_ha,4)} ha • ${fmtN(area_km2,4)} km²</div>
              <div><b>Centro:</b> ${fmtN(c.lat,6)}, ${fmtN(c.lng,6)}</div>
            </div>`;
          } else if(gj.geometry.type==='Point' && !isLabel(layer)){
            const [lng,lat]=gj.geometry.coordinates;
            html=`<div style="font-size:13px;line-height:1.35">
              <div><b>Ponto:</b> ${fmtN(lat,6)}, ${fmtN(lng,6)}</div>
              <div style="color:#6b7280">Dica: segure <b>Alt</b> e clique para copiar.</div>
            </div>`;
          }
          layer.bindPopup(html);
        }catch{}
      }
      function countVerts(geom){
        let c=0;
        if(geom.type==='Polygon') geom.coordinates.forEach(r=> c+=Math.max(0,r.length-1));
        else if(geom.type==='MultiPolygon') geom.coordinates.forEach(p=> p.forEach(r=> c+=Math.max(0,r.length-1)));
        else if(geom.type==='LineString') c=geom.coordinates.length-1;
        else if(geom.type==='MultiLineString') geom.coordinates.forEach(ls=> c+=Math.max(0,ls.length-1));
        return c;
      }
      function applyZoomScaling(){
        const z=E.map.getZoom();
        E.drawn.eachLayer(l=>{
          if(isLabel(l)){
            const o=l._labelOpts||currentLabelOpts();
            const size=scaledSize(l._baseSizePx||o.size||12, l._scaleRefZoom||z);
            const next={...o,size}; l._labelOpts=next; l.setIcon(buildLabelIcon(l.options.htmlText||'', next));
          } else if(l instanceof L.Marker && l.options?.icon?.options?.className==='emoji-pin'){
            const size=scaledSize(l._baseSizePx||22, l._scaleRefZoom||z);
            l.setIcon(iconFor(l._emojiKey||'pin', size));
          }
        });
      }

      function bind(){
        E.drawn=new L.FeatureGroup();E.map.addLayer(E.drawn);
        const ctrl=new L.Control.Draw({position:'topright',draw:false,edit:{featureGroup:E.drawn,remove:true}});
        E.map.addControl(ctrl);

        const handlers={};
        handlers.polygon   = new L.Draw.Polygon(E.map,{shapeOptions:{color:'#1d4ed8',weight:2,fillColor:'#60a5fa',fillOpacity:.25}});
        handlers.rectangle = new L.Draw.Rectangle(E.map,{shapeOptions:{color:'#1d4ed8',weight:2,fillColor:'#60a5fa',fillOpacity:.25}});
        handlers.polyline  = new L.Draw.Polyline(E.map,{shapeOptions:{color:'#1d4ed8',weight:3}});
        handlers.circle    = new L.Draw.Circle(E.map,{shapeOptions:{color:'#16a34a',weight:2,fillColor:'#86efac',fillOpacity:.25}});
        handlers.marker    = new L.Draw.Marker(E.map,{icon:iconFor('pin')});

        function enable(h){
          if(activeHandler) activeHandler.disable();
          activeHandler = h;
          h.enable();
          E.map.getContainer().style.cursor='crosshair';
        }

        UI.btnPoly.onclick   = ()=> enable(handlers.polygon);
        UI.btnRect.onclick   = ()=> enable(handlers.rectangle);
        UI.btnLine.onclick   = ()=> enable(handlers.polyline);
        UI.btnCircle.onclick = ()=> enable(handlers.circle);
        UI.btnMarker.onclick = ()=> enable(handlers.marker);

        const stopDrawing=()=>{
          if(activeHandler){ try{activeHandler.disable();}catch{} activeHandler=null; }
          E.map.getContainer().style.cursor='';
        };

        E.map.on(L.Draw.Event.CREATED,(e)=>{
          const layer=e.layer; E.drawn.addLayer(layer); attach(layer); showInfo(layer); select(layer);
          stopDrawing();
        });
        E.map.on('draw:drawstop', stopDrawing);
        E.map.on('draw:drawvertex', ()=>{});

        E.map.on('draw:edited',(e)=>{ e.layers.eachLayer(l=>{ showInfo(l); if(l._labelRef && l.getBounds){ l._labelRef.setLatLng(l.getBounds().getCenter()); } }); });

        UI.btnEdit.onclick = ()=>{ if(!selected || isLabel(selected)) return; E.editSession = new L.EditToolbar.Edit(E.map,{featureGroup:E.drawn}); E.editSession.enable(); };
        UI.btnSaveEdits.onclick = ()=>{ if(E.editSession){ try{E.editSession.save();}catch{} E.editSession.disable(); E.editSession=null; } };
        UI.btnDelete.onclick = ()=>{ if(!selected) return; if(selected._labelRef){ E.drawn.removeLayer(selected._labelRef); } E.drawn.removeLayer(selected); selected=null; E.toolbar.style.display='none'; };

        [UI.strokeColor,UI.fillColor,UI.strokeWeight,UI.fillOpacity].forEach(node=>{
          node.addEventListener('input', ()=>{
            if(selected && selected.setStyle){
              selected.setStyle({
                color:UI.strokeColor.value,
                weight:parseInt(UI.strokeWeight.value,10),
                fillColor:UI.fillColor.value,
                fillOpacity:parseFloat(UI.fillOpacity.value)
              });
            }
            updateStyleBadges();
          });
        });

        UI.labelText.addEventListener('keydown', e=>{ if(e.key==='Enter') e.preventDefault(); });
        UI.labelText.addEventListener('input', ()=>{ UI.labelText.value = UI.labelText.value.replace(/\s*\n+\s*/g,' '); });

        [UI.labelSize,UI.labelColor,UI.labelFont,UI.labelNoBg,UI.labelBg].forEach(n=>{
          n.addEventListener('input', ()=>{
            if(selected && isLabel(selected)){
              const t=selected.options.htmlText||''; const o=currentLabelOpts();
              selected._baseSizePx=o.size; selected._labelOpts={...(selected._labelOpts||{}),...o};
              applyZoomScaling(); selected.options.htmlText=t;
            }
            if(n===UI.labelSize) updateStyleBadges();
          });
        });

        UI.btnApplyLabel.onclick = ()=>{
          const text = UI.labelText.value.replace(/\s*\n+\s*/g,' ');
          const opts = currentLabelOpts();
          if(selected && isLabel(selected)){
            selected.options.htmlText=text; selected._labelOpts=opts; selected._baseSizePx=opts.size;
            selected._scaleRefZoom = selected._scaleRefZoom ?? E.map.getZoom();
            selected.setIcon( buildLabelIcon(text,{...opts,size:scaledSize(opts.size, selected._scaleRefZoom)}) );
            return;
          }
          if(selected){
            const center=(selected.getBounds?selected.getBounds().getCenter():(selected.getLatLng?selected.getLatLng():E.map.getCenter()));
            applyLabel(selected, center, text, opts);
          } else {
            createFreeLabel(E.map.getCenter(), text, opts);
          }
        };

        UI.btnAddFreeLabel.onclick = ()=> createFreeLabel(E.map.getCenter(), UI.labelText.value.replace(/\s*\n+\s*/g,' '), currentLabelOpts());

        UI.markerIcon.addEventListener('change', ()=>{
          handlers.marker = new L.Draw.Marker(E.map,{icon:iconFor(UI.markerIcon.value)});
          if(selected && selected instanceof L.Marker && !isLabel(selected)){
            selected._emojiKey=UI.markerIcon.value; selected._baseSizePx=selected._baseSizePx||22; selected._scaleRefZoom=selected._scaleRefZoom??E.map.getZoom();
            selected.setIcon( iconFor(UI.markerIcon.value, scaledSize(selected._baseSizePx, selected._scaleRefZoom)) );
          }
        });
        UI.btnAddPoint.onclick = ()=>{
          const m=L.marker(E.map.getCenter(),{icon:iconFor(UI.markerIcon.value),draggable:true});
          m._emojiKey=UI.markerIcon.value; m._baseSizePx=22; m._scaleRefZoom=E.map.getZoom();
          E.drawn.addLayer(m); attach(m); select(m); applyZoomScaling();
        };
        UI.btnApplyIcon.onclick = ()=>{
          if(selected && selected instanceof L.Marker && !isLabel(selected)){
            selected._emojiKey=UI.markerIcon.value; selected._baseSizePx=selected._baseSizePx||22; selected._scaleRefZoom=selected._scaleRefZoom??E.map.getZoom();
            selected.setIcon( iconFor(UI.markerIcon.value, scaledSize(selected._baseSizePx, selected._scaleRefZoom)) );
          } else console.warn('Selecione um ponto para aplicar o ícone.');
        };

        UI.btnCloseToolbar.onclick = ()=>{ E.toolbar.style.display='none'; selected=null; };
        UI.openToolbarBtn.addEventListener('click', ()=>{
          E.toolbar.style.display='block';
          const pos=JSON.parse(sessionStorage.getItem('toolbar_pos')||'null');
          if(pos){ Object.assign(E.toolbar.style,{left:pos.left,top:pos.top,right:'auto',bottom:'auto'}); }
        });

        E.map.on('zoomend', applyZoomScaling);

        function createFreeLabel(latlng,text,opts){
          const lab=L.marker(latlng,{draggable:true,icon:buildLabelIcon(text,opts),zIndexOffset:1000});
          lab.options.htmlText=text; lab._labelOpts=opts; lab._scaleRefZoom=E.map.getZoom(); lab._baseSizePx=opts.size;
          E.drawn.addLayer(lab); attach(lab); select(lab); applyZoomScaling();
        }
        function applyLabel(layer,latlng,text,opts){
          let lab=layer._labelRef;
          if(!lab){
            lab=L.marker(latlng,{draggable:true,icon:buildLabelIcon(text,opts),zIndexOffset:1000});
            lab.options.htmlText=text; lab._labelOpts=opts; lab._scaleRefZoom=E.map.getZoom(); lab._baseSizePx=opts.size;
            E.drawn.addLayer(lab); layer._labelRef=lab; attach(lab);
          }else{
            lab.setLatLng(latlng); lab.setIcon(buildLabelIcon(text,opts));
            lab.options.htmlText=text; lab._labelOpts=opts; lab._baseSizePx=opts.size;
          }
          applyZoomScaling();
        }

        updateStyleBadges();
        Draggable.make(E.toolbar,document.getElementById('dragHandle'));
        LabelEditor.init();
      }

      const LabelEditor=(()=>{
        let box=null,editing=null,dblWas=null;
        function open(label){
          close();
          editing=label; dblWas=E.map.doubleClickZoom.enabled(); E.map.doubleClickZoom.disable();
          const mapEl=document.getElementById('map'); const p=E.map.latLngToContainerPoint(label.getLatLng());
          box=document.createElement('div'); box.className='label-editor'; box.style.left=(p.x+8)+'px'; box.style.top=(p.y-8)+'px';
          box.innerHTML=`<input type="text" id="__labelEdit">`; mapEl.appendChild(box);
          const input=box.querySelector('input'); input.value=(label.options.htmlText||'').trim(); input.select(); input.focus();
          const commit=()=>{
            const txt=input.value.replace(/\s*\n+\s*/g,' ');
            const o=label._labelOpts||currentLabelOpts();
            label.options.htmlText=txt;
            const size=scaledSize(label._baseSizePx||o.size||12, label._scaleRefZoom||E.map.getZoom());
            label.setIcon( buildLabelIcon(txt,{...o,size}) );
            if(editing===label) UI.labelText.value=txt;
            close();
          };
          input.addEventListener('keydown',e=>{ if(e.key==='Enter'){e.preventDefault();commit();} if(e.key==='Escape'){e.preventDefault();close();} });
          input.addEventListener('blur',commit);
        }
        function close(){
          if(box && box.parentNode) box.parentNode.removeChild(box);
          box=null; editing=null; if(dblWas) E.map.doubleClickZoom.enable(); dblWas=null;
        }
        function init(){ document.addEventListener('keydown',e=>{ if(e.key==='Escape' && box){ close(); } }); }
        return{open,close,init};
      })();

      return{bind,isLabel,attach,showInfo};
    })();

    /* GeoJSON IO (merge, sem limpar) */
    const IO=(()=>{
      function pickStyle(layer){
        const o=layer.options||{};
        return{color:o.color||'#1f2937',weight:o.weight||2,fillColor:o.fillColor||'#60a5fa',fillOpacity:(o.fillOpacity!=null?o.fillOpacity:.25)};
      }
      function collect(){
        const fc={type:'FeatureCollection',features:[]};
        E.drawn.eachLayer(layer=>{
          if(Draw.isLabel(layer)){
            const gj=layer.toGeoJSON(); const o=layer._labelOpts||{};
            gj.properties={kind:'label',text:layer.options.htmlText||'',labelOpts:o,baseSizePx:layer._baseSizePx||o.size||12,scaleRefZoom:layer._scaleRefZoom||E.map.getZoom()};
            fc.features.push(gj); return;
          }
          if(layer instanceof L.Circle){
            const c=layer.getLatLng(); const r=layer.getRadius();
            fc.features.push({type:'Feature',geometry:{type:'Point',coordinates:[c.lng,c.lat]},properties:{kind:'circle',radiusMeters:r,style:pickStyle(layer)}});
            return;
          }
          if(layer instanceof L.Marker && layer.options?.icon?.options?.className==='emoji-pin'){
            const gj=layer.toGeoJSON();
            gj.properties={kind:'emoji',emojiKey:layer._emojiKey||'pin',baseSizePx:layer._baseSizePx||22,scaleRefZoom:layer._scaleRefZoom||E.map.getZoom()};
            fc.features.push(gj); return;
          }
          if(layer._labelRef){
            const gj=layer.toGeoJSON(); gj.properties={style:pickStyle(layer),kind:'shape'}; fc.features.push(gj);
            const lj=layer._labelRef.toGeoJSON(); const lo=layer._labelRef._labelOpts||{};
            lj.properties={kind:'label',text:layer._labelRef.options.htmlText||'',labelOpts:lo,baseSizePx:layer._labelRef._baseSizePx||lo.size||12,scaleRefZoom:layer._labelRef._scaleRefZoom||E.map.getZoom()};
            fc.features.push(lj); return;
          }
          if(layer.toGeoJSON){ const gj=layer.toGeoJSON(); gj.properties={style:pickStyle(layer),kind:'shape'}; fc.features.push(gj); }
        });
        return fc;
      }
      function download(fc,name='agromap.geojson'){
        const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/json'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
      }

      function loadMerge(data){
        if(!data) return;
        const seen=new Set();
        const keyLab=(ll,t)=>`${ll.lat.toFixed(6)},${ll.lng.toFixed(6)}|${t}`;

        const lyr=L.geoJSON(data,{
          pointToLayer:(ft,latlng)=>{
            if(ft.properties?.kind==='circle') return L.circle(latlng,{ radius:ft.properties.radiusMeters||0, ...(ft.properties.style||{}) });
            return L.marker(latlng,{draggable:true});
          },
          onEachFeature:(ft,l)=>{
            if(ft.properties?.style && l.setStyle) l.setStyle(ft.properties.style);

            if(ft.properties?.kind==='label'){
              const o=ft.properties.labelOpts||{size:12,color:'#111827',font:"system-ui,-apple-system,Segoe UI,Roboto,Ubuntu",noBg:false,bgColor:'#ffffff'};
              const t=ft.properties.text||'';
              const k=keyLab(l.getLatLng(),t); if(seen.has(k)) return; seen.add(k);
              const bubble=o.noBg?`background:transparent;border:0;box-shadow:none;padding:0`:`background:${o.bgColor};border:1px solid #e5e7eb;box-shadow:0 2px 6px rgba(0,0,0,.08);padding:4px 6px`;
              const lab=L.marker(l.getLatLng(),{
                draggable:true,
                icon:L.divIcon({className:'label-marker',html:`<div class="bubble" style="font-size:${o.size}px;color:${o.color};font-family:${o.font};${bubble};white-space:nowrap;line-height:1.15">${escapeHTML(t)}</div>`}),
                zIndexOffset:1000
              });
              lab.options.htmlText=t; lab._labelOpts=o; lab._baseSizePx=ft.properties.baseSizePx||o.size||12; lab._scaleRefZoom=ft.properties.scaleRefZoom||E.map.getZoom();
              E.drawn.addLayer(lab); Draw.attach(lab);
              return;
            }

            if(ft.properties?.kind==='emoji'){
              const key=ft.properties.emojiKey||'pin';
              const base=ft.properties.baseSizePx||22;
              const refZ=ft.properties.scaleRefZoom||E.map.getZoom();
              const mk=L.marker(l.getLatLng(),{draggable:true,icon:L.divIcon({html:`<div class="emoji" style="font-size:${base}px">📍</div>`,className:'emoji-pin'})});
              mk._emojiKey=key; mk._baseSizePx=base; mk._scaleRefZoom=refZ;
              E.drawn.addLayer(mk); Draw.attach(mk); Draw.showInfo(mk);
              return;
            }

            E.drawn.addLayer(l); Draw.attach(l); Draw.showInfo(l);
          }
        });

        try{
          if(lyr.getLayers().length) E.map.fitBounds(lyr.getBounds(),{padding:[16,16]});
        }catch{}
      }

      function bind(){
        UI.exportGeoJSON.addEventListener('click',()=>download(collect(),'agromap.geojson'));
        UI.geojsonInput.addEventListener('change',ev=>{
          const files=[...(ev.target.files||[])]; if(!files.length) return;
          (async ()=>{
            showLoading('Importando GeoJSON…');
            try{
              for(const f of files){
                const txt=await f.text();
                const obj=JSON.parse(txt);
                const fc = obj.type==='FeatureCollection' ? obj
                         : obj.type==='Feature' ? {type:'FeatureCollection',features:[obj]}
                         : {type:'FeatureCollection',features:[{type:'Feature',geometry:obj,properties:{}}]};
                loadMerge(fc);
              }
            }catch{ alert('GeoJSON inválido.'); }
            finally{ hideLoading(); }
          })();
        });
      }
      return{bind,collect,loadMerge,download};
    })();

    /* Coord / HUD */
    const Coord=(()=>{
      const fmt=(ll)=>`Lat: ${(+ll.lat).toFixed(6)} • Lng: ${(+ll.lng).toFixed(6)}`;
      const fmtCopy=(ll)=>`"${(+ll.lat).toFixed(6)},${(+ll.lng).toFixed(6)}"`;
      function setCross(latlng){
        if(!latlng){ if(E.coord.cross){E.map.removeLayer(E.coord.cross);E.coord.cross=null} return; }
        const html=`<div style="position:relative;width:22px;height:22px"><div style="position:absolute;left:10px;top:0;bottom:0;width:2px;background:#ef4444"></div><div style="position:absolute;top:10px;left:0;right:0;height:2px;background:#ef4444"></div></div>`;
        if(!E.coord.cross){ E.coord.cross=L.marker(latlng,{icon:L.divIcon({html,iconSize:[22,22]}),interactive:false}).addTo(E.map); }
        else E.coord.cross.setLatLng(latlng);
      }
      function updateLabel(ll){ UI.coordMain.textContent=fmt(ll); UI.coordZoom.textContent=E.map.getZoom(); }
      function fixAt(ll){
        E.coord.locked=true;E.coord.fixed=ll;updateLabel(ll);setCross(ll);
        UI.lockBtn.classList.add('active');
        UI.coordState.innerHTML='<span class="coord-locked">• fixado</span>';
      }
      function bind(){
        E.map.on('mousemove',e=>{ if(!E.coord.locked) updateLabel(e.latlng); });
        E.map.on('zoomend',()=>{ UI.coordZoom.textContent=E.map.getZoom(); });
        E.map.on('click',e=>{ if(E.coord.locked) fixAt(e.latlng); });

        UI.lockBtn.addEventListener('click',()=>{
          E.coord.locked=!E.coord.locked;
          if(E.coord.locked){
            fixAt(E.map.getCenter());
          }else{
            E.coord.fixed=null; setCross(null);
            UI.lockBtn.classList.remove('active');
            UI.coordState.textContent='';
          }
        });

        UI.copyBtn.addEventListener('click',()=>{
          const ll=(E.coord.locked&&E.coord.fixed)?E.coord.fixed:E.map.getCenter();
          navigator.clipboard?.writeText(fmtCopy(ll));
          UI.copyBtn.innerHTML='<i class="fa-solid fa-check"></i>';
          setTimeout(()=>UI.copyBtn.innerHTML='<i class="fa-solid fa-copy"></i>',900);
        });

        UI.openToolbarBtn.addEventListener('click',()=>{
          E.toolbar.style.display='block';
          const pos=JSON.parse(sessionStorage.getItem('toolbar_pos')||'null');
          if(pos){ Object.assign(E.toolbar.style,{left:pos.left,top:pos.top,right:'auto',bottom:'auto'}); }
        });

        updateLabel(E.map.getCenter());
      }
      return{bind,fixAt};
    })();

    /* Régua */
    const Ruler=(()=>{
      const fmtDist=(m)=> m<1000 ? `${m.toFixed(1)} m` : `${(m/1000).toFixed((m/1000)<10?2:1)} km`;
      function update(){
        if(!E.measure.line){ UI.rulerValue.textContent='0 m'; return; }
        const pts=E.measure.line.getLatLngs();
        let total=0; for(let i=1;i<pts.length;i++) total+=E.map.distance(pts[i-1],pts[i]);
        UI.rulerValue.textContent=fmtDist(total);
      }
      function clear(){ E.measure.layer.clearLayers(); E.measure.points=[]; E.measure.line=null; E.measure.hasTemp=false; update(); }
      function start(){
        E.measure.on=true; UI.rulerBtn.classList.add('active'); E.map.getContainer().style.cursor='crosshair'; clear();
        E.measure.line=L.polyline([], {color:'#2563eb',weight:3,dashArray:'6,6'}).addTo(E.measure.layer);
        if(!E.map.hasLayer(E.measure.layer)) E.measure.layer.addTo(E.map);
      }
      function addPoint(ll){
        if(!E.measure.line) return;
        if(!E.measure.hasTemp){
          E.measure.line.setLatLngs([ll,ll]);
          E.measure.points.push(L.circleMarker(ll,{radius:4,color:'#2563eb',fillColor:'#2563eb',fillOpacity:1}).addTo(E.measure.layer));
          E.measure.hasTemp=true;
        }else{
          const latlngs=E.measure.line.getLatLngs();
          latlngs[latlngs.length-1]=ll;
          E.measure.line.setLatLngs([...latlngs,ll]);
          E.measure.points.push(L.circleMarker(ll,{radius:4,color:'#2563eb',fillColor:'#2563eb',fillOpacity:1}).addTo(E.measure.layer));
        }
        update();
      }
      function moveTemp(ll){
        if(E.measure.on && E.measure.line && E.measure.hasTemp){
          const latlngs=E.measure.line.getLatLngs();
          latlngs[latlngs.length-1]=ll;
          E.measure.line.setLatLngs(latlngs); update();
        }
      }
      function finish(){
        E.measure.on=false; UI.rulerBtn.classList.remove('active'); E.map.getContainer().style.cursor='';
        if(E.measure.line && E.measure.line.getLatLngs().length<2) clear();
      }
      function bind(){
        UI.rulerBtn.addEventListener('click', ()=> E.measure.on?finish():start());
        UI.rulerClear.addEventListener('click', clear);
        E.map.on('click', e=>{ if(E.measure.on) addPoint(e.latlng); });
        E.map.on('mousemove', e=> moveTemp(e.latlng));
        E.map.on('dblclick', ()=>{ if(E.measure.on) finish(); });
        document.addEventListener('keydown', e=>{ if(e.key==='Escape' && E.measure.on) finish(); });
      }
      return{bind};
    })();

    /* Draggable */
    const Draggable=(()=>({make(el,handle){
      let sx=0,sy=0,ox=0,oy=0,drag=false;
      const down=(x,y)=>{drag=true;el.classList.add('dragging');sx=x;sy=y;const r=el.getBoundingClientRect();ox=r.left;oy=r.top;};
      const move=(x,y)=>{if(!drag)return;Object.assign(el.style,{left:(ox+(x-sx))+'px',top:(oy+(y-sy))+'px',right:'auto',bottom:'auto'})};
      const up=()=>{if(!drag)return;drag=false;el.classList.remove('dragging');sessionStorage.setItem('toolbar_pos',JSON.stringify({left:el.style.left,top:el.style.top}))};
      handle.addEventListener('mousedown',e=>{down(e.clientX,e.clientY);document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu)});
      const mm=(e)=>move(e.clientX,e.clientY);
      const mu=()=>{document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);up()};
      handle.addEventListener('touchstart',e=>{const t=e.touches[0];down(t.clientX,t.clientY)},{passive:true});
      handle.addEventListener('touchmove',e=>{const t=e.touches[0];move(t.clientX,t.clientY)},{passive:true}); /* CORRIGIDO */
      handle.addEventListener('touchend',up,{passive:true});
    }}))();

    /* PIX Card */
    (function PixCard(){
      if(!UI.pixCard) return;
      try{
        UI.pixQrBox.innerHTML='';
        new QRCode(UI.pixQrBox,{text:CONST.PIX_PAYLOAD,width:200,height:200,correctLevel:QRCode.CorrectLevel.M});
      }catch(e){console.error('QR PIX:',e)}
      UI.btnCopyPayload?.addEventListener('click',()=>{navigator.clipboard?.writeText(CONST.PIX_PAYLOAD); const old=UI.btnCopyPayload.innerHTML; UI.btnCopyPayload.innerHTML='<i class="fa-solid fa-check"></i> Copiado'; setTimeout(()=>UI.btnCopyPayload.innerHTML=old,900);});
      UI.btnCopyKey?.addEventListener('click',()=>{navigator.clipboard?.writeText(CONST.PIX_RANDOM_KEY); const old=UI.btnCopyKey.innerHTML; UI.btnCopyKey.innerHTML='<i class="fa-solid fa-check"></i> Copiado'; setTimeout(()=>UI.btnCopyKey.innerHTML=old,900);});
      const show=()=>UI.pixCard.style.display='block', hide=()=>UI.pixCard.style.display='none';
      UI.pixClose?.addEventListener('click',hide);
      let firstTimer=setTimeout(show,60*1000), reTimer=null;
      const reshow=()=>{if(reTimer)clearInterval(reTimer); reTimer=setInterval(show,10*60*1000)};
      UI.pixClose?.addEventListener('click',reshow);
    })();

    /* Projeto */
    function collectProject(){
      const center=E.map.getCenter();
      const base={name:UI.baseSelect.value, labels:UI.chkLabels.checked, center:[center.lat,center.lng], zoom:E.map.getZoom()};
      const pdfs=Object.entries(E.pdfLayers).map(([name,ov])=>({
        name, dataUrl:ov._dataUrl || ov._url,
        bounds:[[ov.getBounds().getSouth(),ov.getBounds().getWest()],[ov.getBounds().getNorth(),ov.getBounds().getEast()]],
        opacity:ov._opacity ?? 1
      }));
      const kml=E.kmlTexts.slice();
      const geo=IO.collect();
      return { "$schema":"agromap-project-v1", version:1, base, geojson:geo, kml, pdfs, savedAt:new Date().toISOString() };
    }
    function downloadProject(){
      const proj=collectProject();
      IO.download(proj,'agromap.agromap.json');
    }
    async function loadProject(obj){
      try{
        if(!obj || obj.version!==1) throw new Error('Formato de projeto inválido ou versão não suportada.');
        showLoading('Carregando projeto…'); /* ALERTA DE CARREGAMENTO DO PROJETO */
        UI.baseSelect.value=obj.base?.name || 'osm';
        UI.chkLabels.checked=!!obj.base?.labels;
        Base.setBase(UI.baseSelect.value);
        if(obj.base?.center && Number.isFinite(obj.base.zoom)){
          E.map.setView(obj.base.center, obj.base.zoom);
        }

        if(obj.geojson) IO.loadMerge(obj.geojson);

        if(Array.isArray(obj.pdfs)){
          Object.keys(E.pdfLayers).forEach(k=>{try{E.map.removeLayer(E.pdfLayers[k])}catch{}});
          E.pdfLayers={};
          UI.pdfControls.innerHTML='';
          obj.pdfs.forEach(p=>{
            try{
              const ov=L.imageOverlay(
                p.dataUrl,
                L.latLngBounds([[p.bounds[0][0],p.bounds[0][1]],[p.bounds[1][0],p.bounds[1][1]]]),
                {opacity:p.opacity??1}
              ).addTo(E.map);
              ov._dataUrl=p.dataUrl; ov._opacity=p.opacity??1; E.pdfLayers[p.name]=ov;
              PDF.addOpacityControl(p.name);
            }catch(e){console.warn('Falha ao restaurar PDF',p?.name,e)}
          });
          PDF.refreshSelect?.();
        }
        (function(){
          const sel=UI.pdfSelect; sel.innerHTML='';
          const names=Object.keys(E.pdfLayers);
          names.forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel.appendChild(o);});
          document.getElementById('extentInfo').style.display=names.length?'block':'none';
        })();

        if(Array.isArray(obj.kml)) KML.loadFromTextList(obj.kml);
      }catch(e){
        alert('Não foi possível importar o projeto: '+e.message);
      } finally{
        hideLoading();
      }
    }

    /* Conexões de botões do Projeto */
    (function bindProjectButtons(){
      UI.btnSaveProject?.addEventListener('click', downloadProject);
      UI.projectInput?.addEventListener('change', async (ev)=>{
        const file = ev.target.files?.[0];
        if(!file) return;
        try{
          const txt = await file.text();
          const obj = JSON.parse(txt);
          await loadProject(obj);
        }catch(e){
          alert('Projeto inválido: '+(e?.message||e));
        }
      });
    })();

    /* Boot */
    Base.init(); Search.bind(); PDF.bind(); KML.bind(); Draw.bind(); IO.bind(); Coord.bind(); Ruler.bind();

        })();
      }catch(e){
        console.error(e);
        document.getElementById('fatalError').style.display='block';
      }
    });
  </script>
</body>
</html>
